{% extends "devhub/base.html" %}

{% set title = _('Status & Versions') %}
{% block title %}{{ dev_page_title(title, addon) }}{% endblock %}

{% macro status(msg) %}
<strong class="{{ status_class(addon) }}">{{ msg }}</strong>
{% endmacro %}

{% block content %}
<header>
  {{ dev_breadcrumbs(addon, items=[(None, title)]) }}
  <h2>{{ addon.name }}</h2>
</header>
<section id="edit-addon" class="primary devhub-form" role="main">
  <div class="item" id="current-version-status">
    <div class="item_wrapper">
      <table>
        <tr>
          <th>{{ _('Currently on AMO') }}</th>
          <th>{{ _('Status') }}</th>
          <th>{{ _('Validation') }}</th>
          {% if waffle.flag('perf-tests') %}
            <th>{{ _('Performance') }}</th>
          {% endif %}
          <th class="version-delete">{{ _('Delete') }}</th>
        </tr>
        {% set version = addon.current_version %}
        <tr>
          <td>
            <strong>
              <a href="{{ url('devhub.versions.edit', addon.slug, version.id) }}"
                 title="{{ _('Edit this version') }}">
                {{ _('Version {0}', 'addon_display_header_version')|f(version.version) }}</a>
            </strong>
            <span title="{{ version.created|isotime }}" class="note">
              {{ version.created|datetime }}
            </span>
          </td>
          <td class="file-status">
            {% for count, status in dev_files_status(version.all_files, addon) %}
                <div>
                  {# L10n: {0} is the number of files #}
                  {{ status }} ({{ ngettext('{0} file', '{0} files', count)|f(count) }})
                </div>
            {% else %}
                {{ _('0 files') }}
            {% endfor %}
          </td>
          <td class="file-validation">
            <ul>
              {% for file in version.all_files %}
                <li>{{ file.platform }}
                <ul>
                {% if file.has_been_validated %}
                  <li><a href="{{ url('devhub.file_validation', addon.slug, file.id) }}">
                    {{ summarize_validation(file.validation) }}</a></li>
                {% else %}
                  <li>{{ _('Not validated.') }}
                    <a href="{{ url('devhub.file_validation', addon.slug, file.id) }}">
                        {{ _('Validate now.') }}</a>
                  </li>
                {% endif %}
                </ul>
                </li>
              {% endfor %}
            </ul>
          </td>
          {% if waffle.flag('perf-tests') %}
            <td class="perf-tests">
              {% include "devhub/addons/listing/perf_file_listing.html" %}
            </td>
          {% endif %}
          <td class="version-delete">
            <a href="#" class="remove" data-version="{{ version.id }}">x</a>
          </td>
        </tr>
      </table>
    </div>
  </div>

  <div class="item" id="next-version-status">
    <div class="item_wrapper">
      <table>
        <tr>
          <th>{{ _('Next version of this add-on') }}</th>
          <th>{{ _('Status') }}</th>
          <th>{{ _('Validation') }}</th>
          {% if waffle.flag('perf-tests') %}
            <th>{{ _('Performance') }}</th>
          {% endif %}
          <th class="version-delete">{{ _('Delete') }}</th>
        </tr>
        {% set version = addon.latest_version %}
        {% if version_disabled(version) %}
          <tr>
            <td colspan="0">
              <a href="#" class="button version-upload">{{ _('Upload a New Version') }}</a>
            </td>
          </tr>
        {% endif %}
        <tr{% if version_disabled(version) %} class="version-disabled"{% endif %}>
          <td>
            <strong>
              <a href="{{ url('devhub.versions.edit', addon.slug, version.id) }}"
                 title="{{ _('Edit this version') }}">
                {{ _('Version {0}', 'addon_display_header_version')|f(version.version) }}</a>
            </strong>
            <span title="{{ version.created|isotime }}" class="note">
              {{ version.created|datetime }}
            </span>
          </td>
          <td class="file-status">
            {% for count, status in dev_files_status(version.all_files, addon) %}
                <div>
                  {# L10n: {0} is the number of files #}
                  {{ status }} ({{ ngettext('{0} file', '{0} files', count)|f(count) }})
                </div>
            {% else %}
                {{ _('0 files') }}
            {% endfor %}
            {% with position = get_position(addon) %}
              {% if position.pos and position.total %}
                <span class="note">
                  {% trans pos=position.pos|numberfmt, total=position.total|numberfmt %}
                    Queue position: {{ pos }} of {{ total }}
                  {% endtrans %}
                </li>
              {% endif %}
            {% endwith %}
          </td>
          <td class="file-validation">
            <ul>
              {% for file in version.all_files %}
                <li>{{ file.platform }}
                <ul>
                {% if file.has_been_validated %}
                  <li><a href="{{ url('devhub.file_validation', addon.slug, file.id) }}">
                    {{ summarize_validation(file.validation) }}</a></li>
                {% else %}
                  <li>{{ _('Not validated.') }}
                    <a href="{{ url('devhub.file_validation', addon.slug, file.id) }}">
                        {{ _('Validate now.') }}</a>
                  </li>
                {% endif %}
                </ul>
                </li>
              {% endfor %}
            </ul>
          </td>
          {% if waffle.flag('perf-tests') %}
            <td class="perf-tests">
              {% include "devhub/addons/listing/perf_file_listing.html" %}
            </td>
          {% endif %}
          <td class="version-delete">
            <a href="#" class="remove" data-version="{{ version.id }}">x</a>
          </td>
        </tr>
      </table>
    </div>
  </div>

  <h3>{{ _('Older versions') }}</h3>
  <div class="item" id="version-list"
       data-stats="{{ url('devhub.versions.stats', addon.slug) }}">
    <div class="item_wrapper">
      <table>
        <tr>
          <th>{{ _('Version') }}</th>
          <th>{{ _('Status') }}</th>
          <th>{{ _('Validation') }}</th>
          {% if waffle.flag('perf-tests') %}
            <th>{{ _('Performance') }}</th>
          {% endif %}
          <th class="version-delete">{{ _('Delete') }}</th>
        </tr>
        <tr>
          <td colspan="0">
            <a href="#" class="button version-upload">{{ _('Upload a New Version') }}</a>
          </td>
        </tr>
        {% for version in versions.object_list %}
          {% if version != addon.current_version and version != addon.latest_version %}
            <tr{% if version_disabled(version) %} class="version-disabled"{% endif %}>
              <td>
                <strong>
                  <a href="{{ url('devhub.versions.edit', addon.slug, version.id) }}"
                     title="{{ _('Edit this version') }}">
                    {{ _('Version {0}', 'addon_display_header_version')|f(version.version) }}</a>
                </strong>
                <span title="{{ version.created|isotime }}" class="note">
                  {{ version.created|datetime }}
                </span>
              </td>
              <td class="file-status">
                {% for count, status in dev_files_status(version.all_files, addon) %}
                    <div>
                      {# L10n: {0} is the number of files #}
                      {{ status }} ({{ ngettext('{0} file', '{0} files', count)|f(count) }})
                    </div>
                {% else %}
                    {{ _('0 files') }}
                {% endfor %}
              </td>
              <td class="file-validation">
                <ul>
                  {% for file in version.all_files %}
                    <li>{{ file.platform }}
                    <ul>
                    {% if file.has_been_validated %}
                      <li><a href="{{ url('devhub.file_validation', addon.slug, file.id) }}">
                        {{ summarize_validation(file.validation) }}</a></li>
                    {% else %}
                      <li>{{ _('Not validated.') }}
                        <a href="{{ url('devhub.file_validation', addon.slug, file.id) }}">
                            {{ _('Validate now.') }}</a>
                      </li>
                    {% endif %}
                    </ul>
                    </li>
                  {% endfor %}
                </ul>
              </td>
              {% if waffle.flag('perf-tests') %}
                <td class="perf-tests">
                  {% include "devhub/addons/listing/perf_file_listing.html" %}
                </td>
              {% endif %}
              <td class="version-delete">
                <a href="#" class="remove" data-version="{{ version.id }}">x</a>
              </td>
            </tr>
          {% endif %}
        {% endfor %}
      </table>
    </div>
    {% if versions.paginator.num_pages > 1 %}
      <div class="listing-footer">
        {{ versions|paginator }}
      </div>
    {% endif %}
  </div>

</section>

<div id="modals">

  {% if addon.can_be_deleted() %}
    <div id="modal-delete" class="modal modal-delete">
      {% include "devhub/addons/listing/delete_form.html" %}
    </div>
  {% endif %}

  <div id="modal-delete-version" class="modal modal-delete">
    <form method="post" action="{{ url('devhub.versions.delete', addon.slug) }}">
      <h3 data-tmpl="{{ _('Delete Version {version}') }}"></h3>
      <p>{{ _('Deleting this version will permanently delete:') }}</p>
      <ul>
        <li id="del-files"></li>
        <li id="del-reviews"></li>
      </ul>
      <p>
      {% trans %}
        <strong>Important:</strong>
        Once a version has been deleted, you may not upload a new
        version with the same version number.
      {% endtrans %}
      <p>{{ _('Deleting a version which has already been reviewed
               may also cause a significant delay in the review of
               your next update.') }}</p>
      <p>{{ _('Are you sure you wish to delete this version?') }}</p>
      {{ csrf() }}
      <div class="modal-actions">
        <input type="hidden" name="version_id" class="version_id">
        <input type="hidden" name="addon_id" class="addon_id" value="{{ addon.id }}">
        <button type="submit" class="delete-button">{{ _('Delete Version') }}</button>
        <button type="submit" class="disable-button" name="disable_version">
          {{ _('Disable Version') }}
        </button>
        {{ _('or') }} <a href="#" class="close">{{ _('Cancel') }}</a>
      </div>
    </form>
  </div>

  {{ add_version_modal(_("Add a new Version"),
                       url('devhub.versions.add', addon.slug),
                       url('devhub.upload_for_addon', addon.slug), _("Add Version") )}}

  {% if not addon.disabled_by_user and not addon.is_disabled %}
  <div id="modal-disable" class="modal">
    <form method="post" action="{{ addon.get_dev_url('disable') }}">
      <h3>
        {{ _('Disable Add-on') }}
      </h3>
      <p>
        {% trans %}
          Disabling your add-on will prevent it from appearing anywhere in our
          gallery and will stop users from receiving automatic updates.
        {% endtrans %}
      </p>
      <p>
        {% trans %}
          Are you sure you wish to disable your add-on?
        {% endtrans %}
      </p>
      {{ csrf() }}
      <input type="hidden" name="version_id" class="version_id">
      <input type="hidden" name="addon_id" class="addon_id" value="{{ addon.id }}">
      <p>
        <button type="submit">
          {{ _('Disable Add-on') }}
        </button>
        {{ _('or') }} <a href="#" class="close">{{ _('Cancel') }}</a>
      </p>
    </form>
  </div>
  {% endif %}

  {% if not addon.is_disabled and addon.is_under_review %}
  <div id="modal-cancel" class="modal">
    <form method="post" action="{{ url('devhub.addons.cancel', addon.slug) }}">
      <h3>{{ _('Cancel Review Request') }}</h3>
      <p>
        {% if addon.status == amo.STATUS_LITE_AND_NOMINATED %}
          {% trans %}
            Canceling your review request will leave your
            add-on as preliminarily reviewed.
          {% endtrans %}
        {% else %}
          {% trans %}
            Canceling your review request will mark your add-on incomplete.
            If you do not complete your add-on after several days
            by re-requesting review, it will be deleted.
          {% endtrans %}
        {% endif %}
      </p>
      <p>
        {% trans %}
          Are you sure you wish to cancel your review request?
        {% endtrans %}
      </p>
      {{ csrf() }}
      <input type="hidden" name="addon_id" class="addon_id" value="{{ addon.id }}">
      <p>
        <button type="submit">{{ _('Cancel Review Request') }}</button>
        {{ _('or') }} <a href="#" class="cancel close">{{ _('Close') }}</a>
      </p>
      <a href="#" class="close">{{ _('Close') }}</a>
    </form>
  </div>
  {% endif %}
</div>

{% include "devhub/includes/addons_edit_nav.html" %}
{% endblock %}

{% from "includes/forms.html" import tip %}
{% set urls = [
  (addon.get_dev_url(), _('Edit Listing')),
  (addon.get_dev_url('owner'), _('Manage Authors & License')),
  (addon.get_dev_url('profile'), _('Manage Developer Profile')),
  (addon.get_dev_url('payments'), _('Manage Payments')),
  (addon.get_dev_url('versions'), _('Manage Status & Versions')),
] %}

{% macro status_and_tip(addon, tip) %}
  <span class="{{ status_class(addon) }}"><b>{{ amo.STATUS_CHOICES[addon.status] }}</b></span>
  <span class="tip tooltip" title="{{ tip }}">?</span>
{% endmacro %}

{% if addon.is_premium() and waffle.switch('allow-refund') %}
  {% do urls.insert(4, (addon.get_dev_url('refunds'), loc('Manage Refunds'))) %}
{% endif %}

<section class="secondary" role="complementary">
  <div class="addon-status">
    <img class="addon-icon" src="{{ addon.icon_url }}">
    <ul class="addon-details">
      <li>
        <strong>
          {{ _('Status:') }}

          {% if addon.disabled_by_user and addon.status != amo.STATUS_DISABLED %}
            <a href="{{ addon.get_dev_url('versions') }}">
              {{ status_and_tip(addon,
                                _("Your add-on's listing is disabled and is not showing
                                   anywhere in our gallery or update service.")) }}
            </a>
          {% elif addon.status == amo.STATUS_NULL %}
            <a href="{{ url('devhub.submit.resume', addon.slug) }}">
              {{ status_and_tip(addon, _('Please complete your add-on.')) }}
            </a>
          {% elif addon.status == amo.STATUS_PENDING %}
            <a href="{{ addon.get_dev_url('versions') }}">
              {{ status_and_tip(addon, _('You will receive an email when the review is complete.')) }}
            </a>
          {% elif addon.status == amo.STATUS_UNREVIEWED %}
            <a href="{{ addon.get_dev_url('versions') }}">
              {{ status_and_tip(addon,
                                _("You will receive an email when the review is complete. Until
                                   then, your add-on is not listed in our gallery but can be
                                   accessed directly from its details page.")) }}
            </a>
          {% elif addon.status == amo.STATUS_NOMINATED %}
            <a href="{{ addon.get_dev_url('versions') }}">
              {{ status_and_tip(addon,
                                _("You will receive an email when the review is complete. Until
                                   then, your add-on is not listed in our gallery but can be
                                   accessed directly from its details page. ")) }}
            </a>
          {% elif addon.status == amo.STATUS_PUBLIC %}
            <a href="{{ addon.get_dev_url('versions') }}">
              {{ status_and_tip(addon,
                                _("Your add-on is displayed in our gallery and users are
                                   receiving automatic updates.")) }}
            </a>
          {% elif addon.status == amo.STATUS_DISABLED %}
            <a href="{{ addon.get_dev_url('versions') }}#version-upload" class="version-upload">
              {{ status_and_tip(addon,
                                _("Your add-on was disabled by a site administrator and is no
                                   longer shown in our gallery. If you have any questions,
                                   please email marketplace-staff@mozilla.org.")) }}
            </a>
          {% elif addon.status == amo.STATUS_LITE %}
            <a href="{{ addon.get_dev_url('versions') }}">
              {{ status_and_tip(addon,
                                _("Your add-on is displayed in our gallery as experimental
                                   and users are receiving automatic updates. Some features
                                   are unavailable to your add-on.")) }}
            </a>
          {% elif addon.status == amo.STATUS_LITE_AND_NOMINATED %}
            <a href="{{ addon.get_dev_url('versions') }}">
              {{ status_and_tip(addon,
                                _("You will receive an email when the full review is complete.
                                   Until then, your add-on is displayed in our gallery as
                                   experimental and users are receiving automatic updates.
                                   Some features are unavailable to your add-on.")) }}
            </a>
          {% elif addon.status == amo.STATUS_PURGATORY %}
            <a href="{{ addon.get_dev_url('versions') }}">
              {{ status_and_tip(addon,
                                _("All add-ons hosted in our gallery must now be reviewed by an
                                   editor. If you wish to continue hosting your add-on, please
                                   click to select a review process.")) }}
            </a>
          {% endif %}
        </strong>
      </li>
      {% if addon.current_version %}
        <li>
          <strong>{{ _('Current Version:') }}</strong>
          <a href="{{ addon.current_version.get_url_path() }}">
            {{ addon.current_version }}
            <span class="tip tooltip" title="{{ _('This is the version of your add-on that will
                                                   be installed if someone clicks the Install
                                                   button on addons.mozilla.org.') }}">?</span>
          </a>
        </li>
      {% endif %}
      <li>
        <strong>{{ _('Last Updated:') }}</strong>
          {{ addon.last_updated|datetime(_('%b %e, %Y')) }}
      </li>
      {% if addon.latest_version and addon.latest_version != addon.current_version %}
        <li>
          <strong>{{ _('Next Version:') }}</strong>
          <a href="{{ addon.latest_version.get_url_path() }}">
            {{ addon.latest_version.version }}
            <span class="tip tooltip" title="{{ _('This is the newest uploaded version, however
                                                   it isnâ€™t live on the site yet.') }}">?</span>
          </a>
        </li>
      {% endif %}
      {% with position = get_position(addon) %}
        {% if position and position.pos and position.total %}
          <li>
            <strong>{{ _('Queue Position:') }}</strong>
            {% trans position=position.pos|numberfmt,
                     total=position.total|numberfmt %}
              {{ position }} of {{ total }}
            {% endtrans %}
          </li>
        {% endif %}
      {% endwith %}
    </ul>
    <p class="addon-upload">
      {% if not addon.is_incomplete() and not addon.is_disabled %}
        <strong>
          <a href="{{ addon.get_dev_url('versions') }}#version-upload" class="version-upload">{{ _('Upload New Version') }}</a>
        </strong>
        &middot;
      {% endif %}
      <a href="{{ addon.get_dev_url('versions') }}">{{ _('View All' ) }}</a>
    </p>
  </div>
  <div class="highlight" id="edit-addon-nav">
    <ul class="refinements">
      {% for url, title in urls %}
        <li {% if url in request.path %}class="selected"{% endif %}>
          <a href="{{ url }}">{{ title }}</a></li>
      {% endfor %}
      <li class="addon-manage">
        {% if check_addon_ownership(request, addon, dev=True) %}
          {% if addon.disabled_by_user and addon.status != amo.STATUS_DISABLED %}
            <a href="{{ addon.get_dev_url('enable') }}" class="enable-addon">{{ _('Enable Add-on') }}</a>
          {% elif not addon.is_disabled %}
            <a href="{{ addon.get_dev_url('versions') }}#disable-addon" class="disable-addon">{{ _('Disable Add-on') }}</a>
          {% endif %}
        {% endif %}
        {% if check_addon_ownership(request, addon) and addon.can_be_deleted() %}
          <a href="{{ addon.get_dev_url('versions') }}#delete-addon" class="delete-addon">{{ _('Delete Add-on') }}</a>
        {% endif %}
      </li>
    </ul>
    <ul class="refinements">
      <li><a href="{{ addon.get_url_path() }}">
        {{ _('View Listing') }}</a></li>
      <li><a href="{{ url('devhub.feed', addon.slug) }}">
        {{ _('View Recent Changes') }}</a></li>
      {% if not theme %}
        <li class="view-stats"><a href="{{ url('stats.overview', addon.slug) }}">
          {{ _('View Statistics Dashboard') }}</a></li>
        <li class="compat-reports">
          <a href="{{ url('compat.reporter_detail', addon.guid) }}">
            <span>{{ _('Compatibility Reports') }}</span>
            {% set compat_counts = get_compat_counts(addon) %}
            <b class="failure" title="{{ _('{0} failure reports')|f(compat_counts.failure) }}">
              {{ compat_counts.failure|numberfmt }}</b>
            <b class="success" title="{{ _('{0} success reports')|f(compat_counts.success) }}">
              {{ compat_counts.success|numberfmt }}</b>
          </a>
        </li>
      {% endif %}
    </ul>
  </div>
</section>
